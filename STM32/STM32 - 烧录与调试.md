无论是烧录还是调试通常都是通过串口完成的
# 串口
串口即串行接口，也称串行通信接口或串行通讯接口，通常指PC端的COM接口，也就是USB接口。但串口也有着区别。
## 串口分类
通过同步与异步可以将串口划分为两类，**同步串行接口**(SSI)是一种常见的工业用通信接口。**异步串行接口**是指UART通用异步接收/发送接口。

串口也可以通过电器标准进行划分，例如**RS-232-C、RS-422、RS485**等，一般的UART通常是指TTL电平的串口。

## 电器标准区别
信号是通过高低电平的变化传递的，但是不同的电器标准高电平和低电平的定义是不一样的。串口中最常用的便是嵌入式MCU的**TTL** 和PC上的**RS-232** 

1. **TTL**：**UART一般接到SOC，使用的是TTL电平**，定义-3.3V-0为低电平L(0)，而0~+3.3V为高电平H(1)。
2. **RS-232**：**一般PC端用的串口是RS232串口**，RS232是负逻辑电平，它定义+5 -+12V为低电平-L(0)，而-12~-5V为高电平-H(1)。RS-232是为点对点（即只用于一对收和发设备）通讯而设计，因为**传输距离短**，所以只适合**本地设备之间**的点对点通信。
3. **RS-422**： 由一个主设备（Master）和多个从设备（Slave）组成，从设备之间不能通信，支持**点对多的双向通信**。RS-422四线接口由于采用单独的发送和接收通道，因此不必控制数据方向，RS-422的最大传输距离为1219米，最大传输速率为10Mb/s。
4. **RS-485**： 采用二线与四线方式，二线制可实现真正的多点双向通信，而采用四线连接时只能实现点对多的通信，即只能有一个主设备，其余为从设备。较RS-422，RS-485无论四线还是二线连接方式总线上可多接到32个设备。最大传输距离约为1219米，最大传输速率为10Mb/s

## PC与嵌入式MCU间的串口通信
由于PC串口使用电平标准RS-232与MCU串口使用的电平标准不一致，所以在进行通信的时候需要将两种电平进行转换。

串口连接方式一般分为两种：
1. USB线（USB转TTL串口）：通过USB/串口转换电路，常见的转换芯片CH340/PL2303实现USB信号和串口的信号转换，此时电脑PC端需要安装一个USB转串口的驱动CH340，虚拟出一个COM口。这是目前**最方便也是最常用的办法**。
2. UART串口线（RS232转TTL型）：通过MAX232芯片实现单片机(UART-TTL电平)和电脑PC端(RS232-电平)的转换，通过串口线连接。（MAX232芯片是美信（MAXIM）公司专为RS-232标准串口设计的单电源电平转换芯片，使用+5v单电源供电）

# 烧录
主要分为ISP(In-System Programming)与IAP(In-Application Programming)，前者是指电路板上的空白器件可以编程写入最终用户代码， 而不需要从电路板上取下器件，已经编程的器件也可以用ISP方式擦除或再编程，ISP是一般常见嵌入式使用的编程方式。IAP指MCU可以在系统中获取新代码并对自己重新编程，即可用程序来改变程序。STM32便采用IAP的烧录方式。

## ISP和IAP的工作原理
### ISP
ISP的实现相对要简单一些，一般通用做法是内部的存储器可以由上位机的软件通过串口来进行改写。对于单片机来讲可以通过SPI或其它的串行接口接收上位机传来的数据并写入存储器中。所以即使我们将芯片焊接在电路板上，只要留出和上位机接口的这个串口，就可以实现芯片内部存储器的改写，而无须再取下芯片。也有通过其他通信协议完成程序的烧录的，**ISP是目前最常用的方法**。

STC 的 51 单片机基于的就是**串口协议**，即程序通过串口写入到 FLASH（EEPROM 的一种）中；Atmel 的 AT89S51，AT89S52 等系列单片机基于 **SPI 协议**将程序写入到 FLASH 中；Arduino 单片机可以通过**串口协议**下载程序，也可以通过 **SPI 协议**下载。STM32 系列的芯片采用 ST-Link 和 J-Link 等设备来下载程序，其基于的协议为 **SWD 和 JTAG**，STM32 也可以基于**串口协议**下载程序，因此它需要支持多种启动模式。

用来写入 FLASH 的这部分程序是芯片出厂就已经固化到芯片当中的，称为**引导程序**，也叫**自举程序**，英文名叫 **BootLoader**。这部分程序是对用户保密的，也就是说用户无法知道这段程序到底是怎么写入 FLASH 的，只知道它能这么做。为实现这种功能，芯片内部 ROM 就可以分为两部分，一部分是**系统存储区** `(System Flash)`，一般在低地址，用来存放引导程序；另一部分是**用户存储区**`(User Flash)`，有些也称为**应用程序区**`(Application Flash)`，一般在高地址，用来存放用户编写的程序（主要执行的部分）。

![[Pasted image 20240615223524.png]]

对于STM32来说就有三种启动模式，其中**主闪存存储器也就是用户存储区**，如果使用 ST-Link 或 J-Link，就可以从用户存储区开始运行，这样上位机就直接将数据写入到用户存储区的 FLASH 中；如果要采用串口下载，就需要从系统存储区开始启动，当芯片在这个部分开始执行程序时，会不断检测串口是否有写入 FLASH 的指令，如果没有，则开始执行后面的用户程序，如果有，则开始写入用户存储区的 FLASH。
从不同的区域启动，适用于不同的情况。
- 从**主闪存存储器**启动，即从flash中启动。flash是用来存储用户代码的区域，从这里启动便是按照运行或修改存储在flash中的用户代码。
- 从**系统存储器**启动，则会触发设置在系统存储器内部的串口下载程序，从串口下载用户代码，并将其写入flash中，需要再次修改为从flash启动，才能启动程序。这样便完成了串口烧录。
- 从**内置SRAM**启动，适用于调试的时候，SRAM下载速度快，内部空间较小，掉电会使其中的数据丢失，但是RESET复位不会。所以在调试程序的时候，选择从SRAM启动比较适合。
### IAP
IAP的实现相对要复杂一些，在实现IAP功能时， 单片机内部一定要有**两块存储区**，一般一块被称为BOOT区，另外一块被称为存储区。单片机上电运行在BOOT区，如果有外部改写程序的条件满足，则对存储区的程序进行改写操作。如果外部改写程序的条件不满足，程序指针跳到存储区，开始执行放在存储区的程序，这样便实现了IAP功能。

看上去IAP与ISP差不多不存在区别，其实不然，对于一个芯片来说，芯片出厂的时候，ISP 程序是已固化到芯片当中的，关键它还是对用户保密的，所以对于使用这个芯片开发产品的开发者来说，是不知道这个芯片到底是怎么将程序烧录到用户 FLASH 中的，所以就不能通过 ISP 来实现需要的功能，而需要**根据芯片提供的一些函数自定义一套协议和规范来写入 FLASH**，这便是IAP。

![[Pasted image 20240616001845.png]]

ISP 程序引导加载 IAP 程序，IAP 程序引导加载应用程序。在开发者开发产品时，IAP 程序必须通过 SWD、JTAG 或者 ISP（串口 or 其他协议）烧录，第二部分应用程序可以在第一部分烧录时一起烧录，也可以通过 IAP 程序烧录。  

那在程序运行过程中，也就是正在执行应用程序时，是怎么跳转到 IAP 程序部分执行的呢？STM32 中是采用中断的方式。一般中断向量都是存放在低地址，而 IAP 恰好在低地址段，所以 IAP 程序就相当于是一个中断服务程序，当相关中断被触发时，芯片就开始执行 IAP 程序，来进行自我更新。因此，在第二部分代码开始执行时，首先需要把 CPU 的中断向量表映像到自己的向量表，然后再执行其他的操作。  

如果 IAP 程序被破坏，产品必须返厂才能重新烧写程序，这是很麻烦并且非常耗费时间和金钱的。针对这样的需求，STM32 在对 Flash 区域实行读保护的同时，自动地对用户 Flash 区的**开始 4 页设置为写保护**，这样可以有效地保证 IAP 程序 (第一部分代码) 区域不会被意外地破坏。

## ICP 与ICSP

### ICP
ICP 全称是`In Circuit Programming`，即在电路中编程，虽然 ICP 和 ISP 在实际使用中有很多重叠，但它们并不能简单地看作是子集关系，而是根据具体的应用场景和需求进行区分。可以认为：
- **ISP 涵盖了更广泛的编程和调试活动**，包括在系统中进行的软件更新和固件开发。
- **ICP 更强调在实际电路环境中的编程**，确保编程操作与实际硬件环境一致。

### ICSP
ICSP 全称是`In Circuit Serial Programming`，在线串行编程，这个主要是出现在 **Arduino** 中，有六个引脚，可用来下载程序。是 AVR 单片机的一个特性，其本质是通过 **SPI** 协议来写入程序，和 AT89S52 的烧录方式差不多。  

Arduino 如果采用 ICSP 的方式烧录程序，那么它还是会从 FLASH 的起始地址开始烧录，也就是说**会覆盖掉低地址段的引导程序**

## 通过串口烧录STM32
知道了烧录的基本过程，我们便可以进行通过串口烧录STM32了。一般默认情况下STM32的BOOT0、BOOT1都被拉低，必须要通过调试器完成烧录。所以想要通过串口烧录STM32必须修改一下BOOT设置，**将BOOT0置高，BOOT1置低**，这样就从系统存储器开始启动，从而开始从串口读取数据并烧录进芯片。
除此之外，还需要一个软件将我们编译好的程序通过串口传入到开发板中。像FlyMcu或者SScom都可以完成这样的任务。
# 调试与调试器
在调试里面有很多缩写名词，其中**JTAG、SWD、SWIMSWIM是仿真器协议接口**；**JLink、ULink、ST-Link是各家公司仿真器的名字**
## JTAG、SWD与SWIM接口
目前调试主要使用JTAG接口和SWD接口，前者使用更为广泛，后者则凭借其更少的端口使用，逐渐代替JTAG的地位，SWIM接口则常见于STM8单片机
### JTAG(**J**oint **T**est **A**ction **G**roup)
是一种国际标准测试协议，主要用于芯片内部测试。现在多数的高级器件都支持JTAG协议，如ARM、DSP、FPGA器件等。JTAG调试接口必须使用VCC、GND电源信号，以及TMS、TCK、TDI、TDO四根调试信号，可选TRST、RESET复位信号和RTCK（同步时钟）信号。
![[Pasted image 20240618144622.png]]
![[Pasted image 20240618144634.png]]
### SWD(**S**erial **W**ire **D**ebug)
是ARM内核调试器的一种通信协议。相比于JTAG协议，占用更少的端口资源。可以看成SWD是JTAG的简化版本，使用更少的端口，且在烧录较大程序的时候更加稳定
![[Pasted image 20240618144704.png]]

![[Pasted image 20240618144714.png]]
SWD模式下，SWDIO的上拉电阻可预留不贴，在ST的一些MCU参考设计中，有提到建议添加，实际测试不加不影响下载。
### SWIM接口
SWIM接口常见于ST的STM8系列单片机，ST-Link2与STM8连接只需要4根线。
![[Pasted image 20240618145321.png]]
## 仿真器/调试器
### J-Link
J-Link是德国SEGGER公司推出基于JTAG的仿真器。将USB接口转换成为JTAG接口的转换器。由于JTAG的普及性，以及J-link使用时的速度、效率和功能都出色，J-Link是仿真器中最经典的一个。J-Link是针对ARM设计的一个小型USB到JTAG转换盒。它通过USB连接到运行Windows的PC主机。J-Link无缝集成到IAR Embedded Workbench for ARM中，它完全兼容 PNP(即插即用)。
1. 支持所有ARM7和ARM9体系;  
2. 下载速度高达50KB/秒;  
3. 无需外接电源(USB取电);  
4. 最高JTAG速度达8MHz;  
5. 自动速度识别;  
6. 固件可升级;  
7. 20脚标准JTAG连接器;  
8. 带USB连线和20脚的扁平线缆;

优点:
1. **高性能**: 调试速度和性能非常高，适合要求苛刻的开发环境。
2. **广泛支持**: 支持大量不同的处理器和开发板，包括 ARM 和非 ARM 设备。
3. **高级功能**: 提供丰富的高级调试功能，如实时跟踪、实时数据传输（RTT）等。
4. **稳定性**: 商业产品，经过广泛测试，具有高度的稳定性和可靠性。

缺点:
1. **成本**: 相对于其他解决方案，J-Link 调试器价格较高。
2. **闭源**: J-Link 是商业闭源产品，不能自由修改。
### CMSIS-DAP 与DAP-LINK
CMSIS-DAP (**C**ortex **M**icrocontroller **S**oftware **I**nterface **S**tandard - **D**ebug **A**ccess **P**ort) 是 ARM 提供的一种标准调试接口协议。它主要用于在开发和调试基于 **ARM Cortex-M** 微控制器的应用程序时，实现调试和编程功能。CMSIS-DAP是开源的，且使用免驱动，支持虚拟串口，稳定便宜。速度介于Jlink与ST-LINK之间。
DAP-LINK由CMSIS-DAP改进过来，除了有CMSIS-DAP的功能，还支持拖拽烧录，升级固件。

优点:
1. **标准化**: 由 ARM 推出的标准化接口，具有广泛的工具和 IDE 支持。
2. **开源**: CMSIS-DAP 是开源项目，可以自由使用和修改。
3. **多平台支持**: 支持 Windows、Linux 和 macOS。
4. **低成本**: 通常可以使用低成本的硬件实现。
5. **易于集成**: 由于其标准化，易于在多种开发环境中集成和使用。

缺点:
1. **性能**: 在某些情况下，调试速度和性能可能不如 J-Link。
2. **功能**: 虽然功能丰富，但与 J-Link 相比，某些高级功能可能缺乏。

>[!warning] DAPlink虽然支持拖拽烧录，但是支持有限，且不能动态识别，只能自己通过重新烧录固件的方法，让其支持拖拽烧录的芯片从原本目标变成修改后目标
### ST-Link
> `ST-LINK`是ST公司开发的一款专门用于`STM8`、`STM32`单片机调试的硬件设备，截至到现在官方已经推出三代产品：`V1`、`V2`、`V3` 。
#### ST-LINK V1
`ST-LINK V1` 是比较老的版本，官网上显示已经停产。目前市面上很少看见有V1版，基本被V2版取代了。
#### ST-LINK V2
`ST-LINK V2` 是目前比较主流的版本，第一款V2产品诞生于2011年，相比于V1有着更高的通信速率。V2 包含两个版本，分别为：ST-LINK V2 与 ST-LINK V2-1。
	`ST-LINK V2` ： 支持STM32和STM8调试，**不带虚拟串口**，淘宝大多数卖的都是这种。
	`ST-LINK V2-1` ： **仅支持STM32调试**，带虚拟串口和虚拟U盘下载，目前ST官方的Nucleo系列评估板上面板载的ST-Link就是这个版本。
#### ST-LINK V3
`ST-LINK V3` 诞生于2018年，目前在市面上普及率还不是很高。ST-LINK V3是针对STM8和STM32的新一代模块化在线调试兼编程功能的工具。V3 相较于 V2 有着更高的数据传输速率，同时具备更高灵活性和扩展性，满足定制化需求。STLINK-V3包含三个版本：STLINK-V3SET、STLINK-V3MINI、STLINK-V3MODS。
	`ST-LINK V3SET`支持大容量存储，具有虚拟COM端口和**多路桥接功能**，烧写性能是上一代探针的三倍。除提供典型的JTAG /串行线调试（SWD）和单线接口模块（SWIM）连接外，STLINK-V3的虚拟COM端口（VCP）和多路桥接器**还可以通过UART、I2C、SPI或CAN接口或GPIO引脚与微控制器通信**。
	`ST-LINK V3MINI`是在ST-LINK V3SET上阉割而来，多路桥接器只支持一个**UART**与微控制器通信。
	`ST-LINK V3MODS`与MINI功能基本差不多，除了基本功能，他也支持**通过UART、I2C、SPI或CAN接口或GPIO引脚与微控制器通信**。但是他的使用方式却截然不同，他是贴在主板上的。
![[Pasted image 20240627114018.png|350]]![[Pasted image 20240627114133.png|350]]
优点:
1. **价格实惠**: 通常随 STM32 开发板附带，成本较低。
2. **专为 STM32 设计**: 与 STM32 微控制器具有很好的兼容性和支持。
3. **广泛使用**: STM32 系列开发板广泛使用，ST-Link 也因此被广泛采用。
4. **稳定性和支持**: 由 STMicroelectronics 提供支持，稳定性好，文档齐全。

缺点:
1. **有限的处理器支持**: 主要支持 STM32 系列微控制器，对其他微控制器支持有限。
2. **功能有限**: 相对于 J-Link，某些高级调试功能可能缺乏。
3. **性能**: 在某些情况下，调试速度和性能可能不如 J-Link。

### 总结

- **CMSIS-DAP** 适合需要开源、标准化、低成本解决方案的用户，特别是在多平台开发环境中使用。
- **J-Link** 适合需要高性能、高稳定性和高级调试功能的用户，尤其是在专业开发环境中。
- **ST-Link** 适合 STM32 微控制器开发，提供价格实惠且与 STM32 设备高度兼容的解决方案。

根据你的具体需求（如成本、性能、支持的处理器类型等），可以选择最合适的调试和编程接口。
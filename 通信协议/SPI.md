 SPI是一种同步串行通信协议，以其**全双工**、**高速率**和简单硬件结构优于UART。它包括MISO、MOSI、SCLK和SS四条线，通过**时钟极性**和**相位配置**实现不同模式的通讯。SPI支持多从机模式，如多NSS或菊花链连接，但**缺乏硬件级别的错误检查**协议，并且通常仅支持一个主设备。在STM32等微控制器中，通过HAL库可以方便地实现SPI编程。

# SPI 信号线
SPI接口一般使用四条信号线通信：
**SDI**（数据输入），**SDO**（数据输出），**SCK**（时钟），**CS**（片选）

`MISO`： 主设备输入/从设备输出引脚。该引脚在从模式下发送数据，在主模式下接收数据。
`MOSI`： 主设备输出/从设备输入引脚。该引脚在主模式下发送数据，在从模式下接收数据。
`SCLK`：串行时钟信号，由主设备产生。
`NSS`  ：从设备片选信号，由主设备控制。它的功能是用来作为“片选引脚”，也就是选择指定的从设备，让主设备可以单独地与特定从设备通讯，避免数据线上的冲突。不同厂家有不同的命名方式NSS\CS\SS，这里统一为NSS

>[!NOTE] 与串口RX/TX一样，SDI与SDO主设备和从设备之间是交叉连接的

# SPI 主从模式

SPI支持主从两种模式，一个SPI通信系统只能有一个主设备，但却可以拥有多个从设备。时钟从主设备输送至从设备，SPI的所有读写操作都是主设备发起的，当有多个从设备的时候，需要借助片选信号确定通信双方参与者。

**SPI 一对一通信**：
![[Pasted image 20241202143425.png]]

**SPI 一对多通信**：
![[Pasted image 20241202143547.png]]

# SPI 传输过程

这里我们以从一个SPI FLASH中读取数据为例，表明传输过程
1. 主设备将片选信号NSS拉低，选择与从设备通信；
2. 发送读取指令，并同步发送时钟信号，从设备接收到时钟的边缘信号时，会立刻进行一次采样读取数据线上的信号。时钟信号由主设备提供，时钟极性的配置将会在后续讲到；
3. 主设备发送读取数据的地址；
4. 主设备在总线上读取数据；
5. 拉高NSS片选信号，终结通信；

一般通信都是主设备通过SPI发送从设备的控制指令，从设备进行执行。由于读写操作都只能通过主设备开启，所以在约定从从设备读取数据的时候，在控制指令传送完成，还需要打开SPI，进行SPI的传输，这时主设备传输的无意义字节会被丢弃，从设备返回的数据在这个期间传输回来。

以STM32为例，在HAL中只有一个SPI传输函数`HAL_SPI_TransmitReceive`,传参是写入数据，而返回值则是读取的数据，这个过程是同步进行，所以在读取数据时候可以写入无意义的0XFF。

# SPI 时钟模式

不同从设备使用的时钟**上下沿模式**是不同，而这往往是从设备从出场就已经确定的事情，我们可以配置主设备使其工作在同一模式下。其主要由**时钟极性**(CPOL)和**时钟相位**(CPHA)来设置。

 时钟极性定义了时钟空闲状态电平：
- CPOL=0 表示SCLK=0时处于空闲态，SCLK有效态时处于高电平
- CPOL=1 表示SCLK=1时处于空闲态，sCLK有效态时处于低电平
 时钟相位定义了数据采集的时间：
- CPHA=0 表示在第一个跳变沿进行数据采样，在第二个边缘发送数据
- CPHA=1 表示在第二个跳变沿进行数据采样，在第一个边缘发送数据

![[Pasted image 20241202155619.png]]

# Standard SPI与Dual SPI、Quad SPI、QPI
![[Pasted image 20241202161530.png]]
标准SPI是通用的接口，而Dual SPI Quad SPI 只适用于flash中，Single-Bit SPI与传统的SPI并无区别，只是适用领域被局限在Flahs中，用以兼容更底层的通信。Dual SPI与传统的SPI最大的区别是，他将输入输出口都利用起来，Flash中很少涉及同时传送和输出，改全双工为半双工，可以极大的提升数据传输速率。同理Quad SPI则是在此之上再加入两根数据线，四根数据线同时输入或输出。

# SPI 总结

优点：
- **高速通信：** SPI支持较高的通信速度，因为它是一种硬件驱动的全双工协议，时钟信号的频率可以非常高，适用于对时延敏感的应用。
- **全双工传输：** SPI可以同时发送和接收数据，提高通信效率。
- **简单的硬件实现：** SPI只需要四根主要信号线（MOSI、MISO、SCLK、CS），硬件结构简单，没有复杂的地址管理。
- **低延迟：** SPI是基于主从模式的直接通信，数据传输延迟低，适合实时性要求高的场景。
- **灵活性：** 可以连接多个从设备，通过片选（CS）信号线选择目标设备，扩展性好。
- **无冲突：** 主设备控制所有通信，避免了总线冲突问题。

缺点：
- **线数较多：** 每增加一个从设备就需要额外的CS线，对于需要连接多个设备的系统，线缆数量增加。
- **短距离限制：** SPI通常适用于设备间的短距离通信，信号衰减和干扰会限制它在长距离场景中的应用。
- **缺乏标准化：** SPI协议没有统一的标准，不同设备的SPI配置（如时钟极性、相位、数据位顺序等）可能不同，需要额外配置。
- **不支持仲裁：** SPI是单主模式，无法实现总线上的多主设备通信。
- **无硬件校验：** SPI本身没有内置的错误检测机制（如奇偶校验或CRC），需要在应用层实现数据完整性检查。
- **单向连接扩展性差：** 如果设备没有支持多从设备的硬件机制，扩展多个设备会变得复杂。

 **适用场景：**
- 高速数据采集（如ADC、DAC模块）
- 存储设备通信（如SD卡、EEPROM、Flash存储器）
- 显示屏驱动（如LCD、OLED）
- 传感器数据传输（如温度传感器、加速度计）